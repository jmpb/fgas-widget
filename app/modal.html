<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>FGAS Modal Widget</title>
	<link rel="stylesheet" href="css/fgas.css">
	<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
</head>

<body>

	<div x-cloak x-data="FGASRecord" @get-record.window="getRecord()">
		<section>
			<div class="card" x-show="loading">
				<p>Loading data...</p>
			</div>
			<div class="card" x-show="!loading">
				<h2 x-text="record.record_name"></h2>
				<div class="field">
					<label for="fgas_record_id">ID:</label>
					<input x-model="record.record_name" name="fgas_record_id" type="text" readonly />
				</div>
				<div class="field">
					<label for="sales_order_number">SO:</label>
					<input x-model="Alpine.store('salesorder_number')" name="sales_order_number" type="text" readonly />
				</div>
				<!-- <div class="action-wrapper">
					<button disabled type="button">Next</button>
				</div> -->
			</div>
		</section>
	</div>

	<div x-cloak x-data="FGASItems" @get-record.window="getItemRecords()">
		<section>
			<div class="card" x-show="loading">
				<p>Loading data...</p>
			</div>
			<div class="toolbar" x-show="!loading">
				<div class="dots">
					<template x-for="[id, item] in Object.entries(records)" :key="id">
						<div class="dot"
							:class="[( id == activeIndex ? 'active' : '' ), ( item.is_new == true ? 'new' : '' )]"
							@click="setActiveRecord(id)" x-text="Number(id)+1">
						</div>
					</template>
				</div>
				<h1>Equipment</h1>
				<div class="actions">
					<div class="add" @click="addItem()" title="Add Item">+</div>
					<div class="delete" @click="deleteItem()" title="Delete Item">x</div>
				</div>
			</div>
			<template x-show="!loading" x-if="activeRecord">
				<div class="card">
					<h2 x-text="activeRecord.cf_fgas_item_id"></h2>
					<div class="field col-span-2">
						<label for="total_gas">Total Gas Charge (g):</label>
						<input x-model="activeRecord.total_gas" name="total_gas" type="number" readonly />
					</div>
					<div class="field">
						<label for="sku">SKU:</label>
						<input x-model="activeRecord.cf_sku" name="sku" type="text" :readonly="!activeRecord.is_new" />
					</div>
					<div class="field">
						<label for="charge">Charge (g):</label>
						<input x-model="activeRecord.cf_charge_g" x-on:change.debounce="calcTotalGas()" name="charge" type="number" />
					</div>
					<div class="field">
						<label for="refrigerant">Refrigerant Gas:</label>
						<input x-model="activeRecord.cf_gas_type" name="refrigerant" type="text" />
					</div>
					<div class="field">
						<label for="quantity">Quantity:</label>
						<input x-model="activeRecord.cf_quantity" x-on:change.debounce="calcTotalGas()" name="quantity" type="number" />
					</div>
					<div class="field">
						<label for="notes">Notes:</label>
						<textarea x-model="activeRecord.cf_notes" rows="3" cols="40"></textarea>
					</div>
				</div>
			</template>
		</section>
	</div>
	
	<div x-cloak x-data="FGASInstallers" @get-record.window="getInstallerRecords()">
		<section>
			<div class="card" x-show="loading">
				<p>Loading data...</p>
			</div>
			<div class="toolbar" x-show="!loading">
				<div class="dots">
					<template x-for="[id, item] in Object.entries(records)" :key="id">
						<div class="dot"
							:class="[( id == activeIndex ? 'active' : '' ), ( item.is_new == true ? 'new' : '' )]"
							@click="setActiveRecord(id)" x-text="Number(id)+1">
						</div>
					</template>
				</div>
				<h1>Installers</h1>
				<div class="actions">
					<div class="add" @click="addInstaller()" title="Add Installer">+</div>
					<div class="delete" @click="deleteInstaller()" title="Delete Installer">x</div>
				</div>
			</div>
			<template x-show="!loading" x-if="activeRecord">
				<div class="card">
					<h2 x-text="activeRecord.cf_installer_id"></h2>
					<div class="field col-span-2">
						<label for="name">Name:</label>
						<input x-model="activeRecord.cf_installer_name" name="name" type="text" />
					</div>
					<div class="field col-span-2">
						<label for="fgas_number">FGAS Number:</label>
						<input x-model="activeRecord.cf_fgas_number" name="fgas_number" type="text" />
					</div>
					<div class="field">
						<label for="notes">Notes:</label>
						<textarea x-model="activeRecord.cf_notes" rows="3" cols="40"></textarea>
					</div>
				</div>
			</template>
		</section>
	</div>

	<script src="https://js.zohostatic.com/zohofinance/v1/zf_sdk.js"></script>
	<script>

		document.addEventListener('alpine:init', () => {	
			Alpine.data('FGASRecord', () => ({
				loading: true,
				record: {},

				getRecord() {
					console.log("Fetching record...");
					getFGASRecord().then((data) => {
						this.record = data;
						this.loading = false;
					});
				}

			}));

			Alpine.data('FGASItems', () => ({
				loading: true,
				records: [],
				activeIndex: 0,
				activeRecord: {},

				getItemRecords() {
					console.log("Fetching item records...");
					getFGASRelatedRecord("cm_fgas_item", "fgasitems").then((data) => {
						this.records = data;
						this.activeRecord = this.records[this.activeIndex];
						this.calcTotalGas();
						this.loading = false;
					});
				},

				nextItemRecord() {
					this.activeIndex < this.records.length ? this.activeIndex++ : this.activeIndex = 0;
					this.activeRecord = this.records[this.activeIndex];
					this.calcTotalGas();
				},

				prevItemRecord() {
					this.activeIndex > 0 ? this.activeIndex-- : this.activeIndex = this.records.length;
					this.activeRecord = this.records[this.activeIndex];
					this.calcTotalGas();
				},

				setActiveRecord(id) {
					this.activeIndex = id;
					this.activeRecord = this.records[this.activeIndex];
					this.calcTotalGas();
				},

				addItem() {
					let newItem = {
						cf_fgas_item_id: "New item",
						cf_sku: "",
						cf_charge_g: "",
						cf_gas_type: "",
						cf_quantity: "",
						cf_notes: "",
						is_new: true
					};
					this.records.push(newItem);
					this.activeIndex = this.records.length - 1;
					this.activeRecord = this.records[this.activeIndex];
					this.calcTotalGas();
				},

				deleteItem() {
					if (confirm("Really delete FGAS record for item: " + this.activeRecord.cf_fgas_item_id + "? This cannot be undone.")) {
						this.records.splice(this.activeIndex, 1);
						this.activeIndex = 0;
						this.activeRecord = this.records[this.activeIndex];
						this.calcTotalGas();
					}
				},

				calcTotalGas() {
					this.activeRecord.total_gas = this.activeRecord.cf_quantity * this.activeRecord.cf_charge_g;
				}
			}));

			Alpine.data('FGASInstallers', () => ({
				loading: true,
				records: [],
				activeIndex: 0,
				activeRecord: {},

				getInstallerRecords() {
					console.log("Fetching installer records...");
					getFGASRelatedRecord("cm_fgas_installer", "fgasinstallers").then((data) => {
						this.records = data;
						this.activeRecord = this.records[this.activeIndex];
						this.loading = false;
					});
				},

				nextItemRecord() {
					this.activeIndex < this.records.length ? this.activeIndex++ : this.activeIndex = 0;
					this.activeRecord = this.records[this.activeIndex];
				},

				prevItemRecord() {
					this.activeIndex > 0 ? this.activeIndex-- : this.activeIndex = this.records.length;
					this.activeRecord = this.records[this.activeIndex];
				},

				setActiveRecord(id) {
					this.activeIndex = id;
					this.activeRecord = this.records[this.activeIndex];
				},

				addInstaller() {
					let newItem = {
						cf_installer_id: "New Installer",
						cf_installer_name: "",
						cf_fgas_number: "",
						cf_notes: "",
						is_new: true
					};
					this.records.push(newItem);
					this.activeIndex = this.records.length - 1;
					this.activeRecord = this.records[this.activeIndex];
				},

				deleteInstaller() {
					if (confirm("Really delete FGAS record for installer: " + this.activeRecord.cf_installer_name + "? This cannot be undone.")) {
						this.records.splice(this.activeIndex, 1);
						this.activeIndex = 0;
						this.activeRecord = this.records[this.activeIndex];
					}
				},
			}));
		});

		window.onload = function () {

			ZFAPPS.extension.init().then(function (App) {

				// Prepare UI.
				resizeModal().then(() => {
				});

				// Prepare data.
				getSONumber().then(() => {
					const event = new CustomEvent('get-record');
					window.dispatchEvent(event); // dispatch custom event to let FGASRecord know it can fetch now
					console.log("'get-record' event dispatched!");
					getFGASRelatedRecord("cm_fgas_installer", "fgasinstallers"); // Alpine.store('fgasinstallers')
				});
			
			});

		};
	</script>

	<script src="js/extension.js"></script>
</body>

</html>
